{% extends "base.html" %}

{% block title %}Campaigns - Email Mass Sender{% endblock %}
{% block page_title %}Campaigns{% endblock %}

{% block page_actions %}
<div class="btn-toolbar mb-2 mb-md-0">
    <div class="btn-group me-2">
        <a href="{{ url_for('new_campaign') }}" class="btn btn-primary">
            <i class="fas fa-plus me-2"></i>
            New Campaign
        </a>
    </div>
    <div class="input-group input-group-sm" style="width: 260px;">
        <span class="input-group-text">Max Concurrent</span>
        <input type="number" class="form-control" id="global_max_concurrent" value="50" min="1" max="200">
    </div>
</div>
{% endblock %}

{% block content %}
<!-- Warning message for no active accounts -->
<div id="no-accounts-warning" class="alert alert-warning d-none" role="alert">
    <i class="fas fa-exclamation-triangle me-2"></i>
    <strong>No Email Accounts Found!</strong> You need to add email accounts before campaigns can send emails.
    <a href="{{ url_for('accounts') }}" class="alert-link">Go to Accounts page</a> to add your email accounts.
</div>
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h6 class="m-0 font-weight-bold text-primary">
            <i class="fas fa-bullhorn me-2"></i>
            Campaigns
        </h6>
    </div>
    <div class="card-body">
        {% if campaigns and campaigns|length > 0 %}
        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Subject</th>
                        <th>Status</th>
                        <th>Totals</th>
                        <th>Created</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for c in campaigns %}
                    <tr>
                        <td>{{ c.name }}</td>
                        <td>{{ c.subject }}</td>
                        <td>
                            <span class="badge{% if c.status == 'completed' %} bg-success{% elif c.status == 'running' %} bg-warning text-dark{% elif c.status == 'failed' %} bg-danger{% else %} bg-secondary{% endif %}">
                                {{ c.status|capitalize }}
                            </span>
                        </td>
                        <td>
                            <small>Total: {{ c.total_recipients or 0 }}</small><br>
                            <small>Sent: {{ c.sent_count or 0 }}</small><br>
                            <small>Failed: {{ c.failed_count or 0 }}</small>
                        </td>
                        <td>{{ c.created_at.strftime('%Y-%m-%d %H:%M') if c.created_at else '-' }}</td>
                        <td>
                            <div class="btn-group" role="group">
                                <a href="{{ url_for('campaign_detail', campaign_id=c.id) }}" class="btn btn-sm btn-outline-info" title="View Details">
                                    <i class="fas fa-eye"></i>
                                </a>
                                <a href="{{ url_for('edit_campaign', campaign_id=c.id) }}" class="btn btn-sm btn-outline-primary" title="Edit Campaign">
                                    <i class="fas fa-edit"></i>
                                </a>
                                {% if c.status == 'running' %}
                                <button class="btn btn-sm btn-outline-warning" disabled title="Campaign Running">
                                    <i class="fas fa-spinner fa-spin"></i>
                                </button>
                                {% else %}
                                <button class="btn btn-sm btn-outline-success" type="button" data-action="start-campaign" data-id="{{ c.id }}" title="Start Campaign">
                                    <i class="fas fa-play"></i>
                                </button>
                                {% endif %}
                                <button class="btn btn-sm btn-outline-danger" data-action="delete-campaign" data-id="{{ c.id }}" title="Delete Campaign">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-5">
            <div class="mb-3"><i class="fas fa-bullhorn fa-3x text-muted"></i></div>
            <p class="text-muted mb-3">No campaigns yet. Create your first campaign.</p>
            <a href="{{ url_for('new_campaign') }}" class="btn btn-primary">
                <i class="fas fa-plus me-2"></i>New Campaign
            </a>
        </div>
        {% endif %}
    </div>
</div>

<!-- Send Campaign Modal -->
<div class="modal fade" id="sendCampaignModal" tabindex="-1" aria-labelledby="sendCampaignModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="sendCampaignModalLabel">
                    <i class="fas fa-paper-plane me-2"></i>
                    Start Campaign
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="sendCampaignForm">
                    <div class="mb-3">
                        <label for="maxConcurrent" class="form-label">Max Concurrent Sends</label>
                        <input type="number" class="form-control" id="maxConcurrent" name="maxConcurrent" value="50" min="1" max="100">
                        <div class="form-text">Number of emails to send simultaneously (1-100)</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="proxy" class="form-label">Proxy (Optional)</label>
                        <input type="text" class="form-control" id="proxy" name="proxy" 
                               placeholder="socks5://user:pass@host:port or http://host:port">
                        <div class="form-text">e.g., socks5://user:pass@host:port or http://host:port</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="emailListFile" class="form-label">Email List File (Optional)</label>
                        <input type="file" class="form-control" id="emailListFile" name="emailListFile" accept=".txt,.csv,.xlsx,.xls">
                        <div class="form-text">Upload a file containing email addresses (one per line or CSV format)</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="batchSize" class="form-label">Batch Size</label>
                        <input type="number" class="form-control" id="batchSize" name="batchSize" value="50" min="1" max="500">
                        <div class="form-text">Number of emails to send per batch (1-500)</div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Select Sending Accounts</label>
                        <div class="form-text mb-2">Choose which accounts to use for sending this campaign:</div>
                        <div id="accountSelection" class="border rounded p-3" style="max-height: 200px; overflow-y: auto;">
                            <div class="text-center text-muted">
                                <i class="fas fa-spinner fa-spin me-2"></i>
                                Loading accounts...
                            </div>
                        </div>
                        <div class="form-text mt-2">
                            <button type="button" class="btn btn-sm btn-outline-primary" id="selectAllAccounts">
                                <i class="fas fa-check-square me-1"></i>Select All
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" id="deselectAllAccounts">
                                <i class="fas fa-square me-1"></i>Deselect All
                            </button>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="confirmSendCampaign">
                    <i class="fas fa-play me-2"></i>
                    Start Campaign
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let currentCampaignId = null;
let availableAccounts = [];

// Wait for DOM to be ready before attaching event listeners
document.addEventListener('DOMContentLoaded', function() {
    // Manual click handler for start campaign buttons
    document.addEventListener('click', function(e) {
        const startBtn = e.target.closest('[data-action="start-campaign"]');
        if (startBtn) {
            e.preventDefault();
            e.stopPropagation();
            
            const campaignId = startBtn.getAttribute('data-id');
            if (campaignId) {
                currentCampaignId = campaignId;
                const modal = new bootstrap.Modal(document.getElementById('sendCampaignModal'));
                modal.show();
            }
        }
    });
    
    // Load accounts when modal is shown
    document.getElementById('sendCampaignModal').addEventListener('show.bs.modal', async function (event) {
        if (!currentCampaignId) {
            console.error('No campaign ID available');
            return;
        }
        
        // Load available accounts
        try {
            const response = await fetch(`/campaigns/${currentCampaignId}/accounts`);
            const data = await response.json();
            
            if (data.success) {
                availableAccounts = data.accounts;
                renderAccountSelection();
            } else {
                document.getElementById('accountSelection').innerHTML = 
                    '<div class="text-center text-danger"><i class="fas fa-exclamation-triangle me-2"></i>Error loading accounts</div>';
            }
        } catch (error) {
            console.error('Error loading accounts:', error);
            document.getElementById('accountSelection').innerHTML = 
                '<div class="text-center text-danger"><i class="fas fa-exclamation-triangle me-2"></i>Error loading accounts</div>';
        }
    });

    // Select all accounts
    document.getElementById('selectAllAccounts').addEventListener('click', function() {
        document.querySelectorAll('#accountSelection input[type="checkbox"]').forEach(checkbox => {
            checkbox.checked = true;
        });
    });

    // Deselect all accounts
    document.getElementById('deselectAllAccounts').addEventListener('click', function() {
        document.querySelectorAll('#accountSelection input[type="checkbox"]').forEach(checkbox => {
            checkbox.checked = false;
        });
    });

    // Confirm send campaign
    document.getElementById('confirmSendCampaign').addEventListener('click', async function() {
        const maxConcurrent = document.getElementById('maxConcurrent').value;
        const proxy = document.getElementById('proxy').value.trim();
        const batchSize = document.getElementById('batchSize').value;
        const emailListFile = document.getElementById('emailListFile').files[0];
        const selectedAccounts = Array.from(document.querySelectorAll('#accountSelection input[type="checkbox"]:checked'))
            .map(checkbox => checkbox.value);
        
        if (selectedAccounts.length === 0) {
            alert('Please select at least one account to send from.');
            return;
        }
        
        // Prepare form data for file upload
        const formData = new FormData();
        formData.append('max_concurrent', parseInt(maxConcurrent));
        formData.append('selected_accounts', JSON.stringify(selectedAccounts));
        formData.append('proxy', proxy || '');
        formData.append('batch_size', parseInt(batchSize));
        
        if (emailListFile) {
            formData.append('email_list_file', emailListFile);
        }
        
        try {
            const response = await fetch(`/campaigns/${currentCampaignId}/send`, {
                method: 'POST',
                body: formData  // Use FormData instead of JSON for file upload
            });
            
            const data = await response.json();
            
            if (data.success) {
                // Close modal
                bootstrap.Modal.getInstance(document.getElementById('sendCampaignModal')).hide();
                
                // Show progress modal if session_id is provided
                if (data.session_id) {
                    showProgressModal(data.session_id);
                } else {
                    // Fallback: reload page
                    location.reload();
                }
            } else {
                alert('Error starting campaign: ' + data.error);
            }
        } catch (error) {
            console.error('Error starting campaign:', error);
            alert('Error starting campaign. Please try again.');
        }
    });
});

function renderAccountSelection() {
    const container = document.getElementById('accountSelection');
    
    if (availableAccounts.length === 0) {
        container.innerHTML = '<div class="text-center text-muted"><i class="fas fa-info-circle me-2"></i>No accounts available</div>';
        return;
    }
    
    container.innerHTML = availableAccounts.map(account => `
        <div class="form-check mb-2">
            <input class="form-check-input" type="checkbox" value="${account.email}" id="account_${account.email.replace('@', '_at_')}" checked>
            <label class="form-check-label" for="account_${account.email.replace('@', '_at_')}">
                <strong>${account.email}</strong>
                <small class="text-muted ms-2">(${account.type})</small>
            </label>
        </div>
    `).join('');
}

// Auto-refresh campaign status every 30 seconds
setInterval(async () => {
    try {
        // Get all campaign IDs from the current page
        const campaignRows = document.querySelectorAll('tbody tr');
        const campaignIds = Array.from(campaignRows)
            .map(row => {
                const startBtn = row.querySelector('[data-action="start-campaign"]');
                const deleteBtn = row.querySelector('[data-action="delete-campaign"]');
                return startBtn?.getAttribute('data-id') || deleteBtn?.getAttribute('data-id');
            })
            .filter(id => id);
        
        // Update each campaign status
        for (const campaignId of campaignIds) {
            try {
                const response = await fetch(`/campaigns/${campaignId}/status`);
                const data = await response.json();
                
                if (data.success) {
                    const campaign = data.campaign;
                    const row = document.querySelector(`[data-action="start-campaign"][data-id="${campaignId}"]`)?.closest('tr') ||
                               document.querySelector(`[data-action="delete-campaign"][data-id="${campaignId}"]`)?.closest('tr');
                    
                    if (row) {
                        // Update status badge
                        const statusBadge = row.querySelector('.badge');
                        if (statusBadge) {
                            statusBadge.textContent = campaign.status.charAt(0).toUpperCase() + campaign.status.slice(1);
                            statusBadge.className = `badge ${getStatusClass(campaign.status)}`;
                        }
                        
                        // Update totals
                        const totalsCell = row.querySelector('td:nth-child(4)');
                        if (totalsCell) {
                            totalsCell.innerHTML = `
                                <div class="small">
                                    <div>Total: ${campaign.total_recipients}</div>
                                    <div>Sent: ${campaign.sent_count}</div>
                                    <div>Failed: ${campaign.failed_count}</div>
                                </div>
                            `;
                        }
                        
                        // Update action buttons
                        const actionButtons = row.querySelector('.btn-group');
                        if (actionButtons) {
                            if (campaign.status === 'running') {
                                actionButtons.innerHTML = `
                                    <a href="/campaigns/${campaignId}" class="btn btn-sm btn-outline-primary" title="View Details">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    <a href="/campaigns/${campaignId}/edit" class="btn btn-sm btn-outline-secondary" title="Edit Campaign">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    <button class="btn btn-sm btn-outline-warning" disabled title="Campaign Running">
                                        <i class="fas fa-spinner fa-spin"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" data-action="delete-campaign" data-id="${campaignId}" title="Delete Campaign">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                `;
                            } else if (campaign.status === 'completed') {
                                actionButtons.innerHTML = `
                                    <a href="/campaigns/${campaignId}" class="btn btn-sm btn-outline-primary" title="View Details">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    <a href="/campaigns/${campaignId}/edit" class="btn btn-sm btn-outline-secondary" title="Edit Campaign">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    <button class="btn btn-sm btn-outline-success" data-action="start-campaign" data-id="${campaignId}" title="Start Campaign">
                                        <i class="fas fa-play"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" data-action="delete-campaign" data-id="${campaignId}" title="Delete Campaign">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                `;
                            }
                        }
                    }
                }
            } catch (error) {
                console.log(`Failed to update campaign ${campaignId}:`, error);
            }
        }
    } catch (error) {
        console.log('Auto-refresh failed:', error);
    }
}, 30000); // Refresh every 30 seconds

// Helper function to get status badge class
function getStatusClass(status) {
    switch (status) {
        case 'completed': return 'bg-success';
        case 'running': return 'bg-warning text-dark';
        case 'failed': return 'bg-danger';
        case 'draft': return 'bg-secondary';
        default: return 'bg-secondary';
    }
}

// Check for active accounts on page load
document.addEventListener('DOMContentLoaded', async () => {
    try {
        const res = await fetch('/accounts');
        const text = await res.text();
        // Simple check - if accounts table is empty, show warning
        if (text.includes('No accounts yet') || text.includes('No email accounts')) {
            document.getElementById('no-accounts-warning').classList.remove('d-none');
        }
    } catch (e) {
        console.log('Could not check accounts status');
    }
});

// Handle delete via event delegation to avoid inline handlers
document.addEventListener('click', async (e) => {
    const delBtn = e.target.closest('[data-action="delete-campaign"]');
    if (!delBtn) return;
    const id = delBtn.getAttribute('data-id');
    if (!id) return;

    if (!confirm('Are you sure you want to delete this campaign? This action cannot be undone and will delete all recipients.')) {
        return;
    }
    try {
        const res = await fetch(`{{ url_for('delete_campaign', campaign_id=0) }}`.replace('0', id), {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        const data = await res.json();
        if (!data.success) {
            alert(data.error || 'Failed to delete campaign');
            return;
        }
        // Remove the row from the table
        const row = delBtn.closest('tr');
        if (row) row.remove();

        // Check if table is empty and show message
        const tbody = document.querySelector('tbody');
        if (tbody && tbody.children.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center py-5">
                        <div class="mb-3"><i class="fas fa-bullhorn fa-3x text-muted"></i></div>
                        <p class="text-muted mb-3">No campaigns yet. Create your first campaign.</p>
                        <a href="{{ url_for('new_campaign') }}" class="btn btn-primary">
                            <i class="fas fa-plus me-2"></i>New Campaign
                        </a>
                    </td>
                </tr>
            `;
        }
        showNotification('Campaign deleted successfully!', 'success');
    } catch (err) {
        alert('Network error');
    }
});

// Function to show notifications
function showNotification(message, type = 'info') {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `alert alert-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'info'} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `;
    
    // Add to page
    document.body.appendChild(notification);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 5000);
}

// Progress tracking functions
function showProgressModal(sessionId) {
    // Include progress modal if not already included
    if (!document.getElementById('progressModal')) {
        fetch('/static/progress_modal.html')
            .then(response => response.text())
            .then(html => {
                document.body.insertAdjacentHTML('beforeend', html);
                // Call the showProgressModal function from the included script
                window.showProgressModal(sessionId);
            })
            .catch(error => {
                console.error('Error loading progress modal:', error);
                showAlert('error', 'Failed to load progress modal');
            });
    } else {
        // Call the existing function
        window.showProgressModal(sessionId);
    }
}
</script>

<!-- Include Progress Modal -->
{% include 'progress_modal.html' %}
{% endblock %}


