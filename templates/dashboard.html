{% extends "base.html" %}

{% block title %}Dashboard - Email Mass Sender{% endblock %}
{% block page_title %}Dashboard{% endblock %}

{% block content %}
<div class="row">
    <!-- Statistics Cards -->
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card stat-card">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-uppercase mb-1">Total Accounts</div>
                        <div class="stat-number">{{ total_accounts }}</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-users fa-2x text-white-50"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card stat-card">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-uppercase mb-1">Active Accounts</div>
                        <div class="stat-number">{{ active_accounts }}</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-user-check fa-2x text-white-50"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    
</div>

<div class="row">
    <!-- Provider Statistics -->
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-chart-pie me-2"></i>
                    Accounts by Provider
                </h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-6 mb-3">
                        <div class="d-flex align-items-center">
                            <div class="bg-primary rounded-circle p-2 me-3">
                                <i class="fas fa-building text-white"></i>
                            </div>
                            <div>
                                <div class="text-xs font-weight-bold text-uppercase mb-1">Office365</div>
                                <div class="h5 mb-0">{{ provider_stats.office365 }}</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 mb-3">
                        <div class="d-flex align-items-center">
                            <div class="bg-danger rounded-circle p-2 me-3">
                                <i class="fas fa-envelope text-white"></i>
                            </div>
                            <div>
                                <div class="text-xs font-weight-bold text-uppercase mb-1">Gmail</div>
                                <div class="h5 mb-0">{{ provider_stats.gmail }}</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 mb-3">
                        <div class="d-flex align-items-center">
                            <div class="bg-warning rounded-circle p-2 me-3">
                                <i class="fas fa-at text-white"></i>
                            </div>
                            <div>
                                <div class="text-xs font-weight-bold text-uppercase mb-1">Yahoo</div>
                                <div class="h5 mb-0">{{ provider_stats.yahoo }}</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 mb-3">
                        <div class="d-flex align-items-center">
                            <div class="bg-info rounded-circle p-2 me-3">
                                <i class="fas fa-globe text-white"></i>
                            </div>
                            <div>
                                <div class="text-xs font-weight-bold text-uppercase mb-1">Hotmail</div>
                                <div class="h5 mb-0">{{ provider_stats.hotmail }}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Sending Statistics -->
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-chart-line me-2"></i>
                    Sending Statistics
                </h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-6 mb-3">
                        <div class="d-flex align-items-center">
                            <div class="bg-success rounded-circle p-2 me-3">
                                <i class="fas fa-check text-white"></i>
                            </div>
                            <div>
                                <div class="text-xs font-weight-bold text-uppercase mb-1">Sent</div>
                                <div class="h5 mb-0">{{ sender_stats.total_sent or 0 }}</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 mb-3">
                        <div class="d-flex align-items-center">
                            <div class="bg-danger rounded-circle p-2 me-3">
                                <i class="fas fa-times text-white"></i>
                            </div>
                            <div>
                                <div class="text-xs font-weight-bold text-uppercase mb-1">Failed</div>
                                <div class="h5 mb-0">{{ sender_stats.total_failed or 0 }}</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 mb-3">
                        <div class="d-flex align-items-center">
                            <div class="bg-warning rounded-circle p-2 me-3">
                                <i class="fas fa-clock text-white"></i>
                            </div>
                            <div>
                                <div class="text-xs font-weight-bold text-uppercase mb-1">Throttled</div>
                                <div class="h5 mb-0">{{ sender_stats.total_throttled or 0 }}</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 mb-3">
                        <div class="d-flex align-items-center">
                            <div class="bg-info rounded-circle p-2 me-3">
                                <i class="fas fa-tasks text-white"></i>
                            </div>
                            <div>
                                <div class="text-xs font-weight-bold text-uppercase mb-1">Active</div>
                                <div class="h5 mb-0">{{ sender_stats.active_tasks or 0 }}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Recent Campaigns -->
    <div class="col-lg-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-paper-plane me-2"></i>
                    Send Mass Email
                </h6>
                <a href="{{ url_for('direct_send') }}" class="btn btn-primary btn-sm">
                    <i class="fas fa-arrow-right me-2"></i>
                    Go to Send Page
                </a>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="card border-primary">
                            <div class="card-body text-center">
                                <i class="fas fa-upload fa-3x text-primary mb-3"></i>
                                <h6 class="card-title">Upload Email List</h6>
                                <p class="card-text text-muted">Upload a file containing email addresses (TXT, CSV, XLSX)</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card border-success">
                            <div class="card-body text-center">
                                <i class="fas fa-layer-group fa-3x text-success mb-3"></i>
                                <h6 class="card-title">Batch Processing</h6>
                                <p class="card-text text-muted">Send emails in configurable batches with BCC support</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-4">
                    <h6 class="mb-3">How to Send Mass Emails:</h6>
                    <ol class="mb-0">
                        <li><strong>Upload File:</strong> Choose your email list file</li>
                        <li><strong>Set Batch Size:</strong> Configure how many emails per batch</li>
                        <li><strong>Select Accounts:</strong> Choose which accounts to send from</li>
                        <li><strong>Send:</strong> Click send and monitor progress</li>
                    </ol>
                </div>
                
                <div class="mt-4 text-center">
                    <a href="{{ url_for('direct_send') }}" class="btn btn-primary btn-lg">
                        <i class="fas fa-paper-plane me-2"></i>Start Sending Mass Emails
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-bolt me-2"></i>
                    Quick Actions
                </h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <a href="{{ url_for('add_account') }}" class="btn btn-outline-primary w-100">
                            <i class="fas fa-user-plus fa-2x mb-2"></i>
                            <br>
                            Add Account
                        </a>
                    </div>
                    
                    
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Send Campaign Modal -->
<div class="modal fade" id="sendCampaignModal" tabindex="-1" aria-labelledby="sendCampaignModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="sendCampaignModalLabel">
                    <i class="fas fa-paper-plane me-2"></i>
                    Start Campaign
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="sendCampaignForm">
                    <div class="mb-3">
                        <label for="maxConcurrent" class="form-label">Max Concurrent Sends</label>
                        <input type="number" class="form-control" id="maxConcurrent" name="maxConcurrent" value="50" min="1" max="100">
                        <div class="form-text">Number of emails to send simultaneously (1-100)</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="proxy" class="form-label">Proxy (Optional)</label>
                        <input type="text" class="form-control" id="proxy" name="proxy" 
                               placeholder="socks5://user:pass@host:port or http://host:port">
                        <div class="form-text">e.g., socks5://user:pass@host:port or http://host:port</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="emailListFile" class="form-label">Email List File (Optional)</label>
                        <input type="file" class="form-control" id="emailListFile" name="emailListFile" accept=".txt,.csv,.xlsx,.xls">
                        <div class="form-text">Upload a file containing email addresses (one per line or CSV format)</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="batchSize" class="form-label">Batch Size</label>
                        <input type="number" class="form-control" id="batchSize" name="batchSize" value="50" min="1" max="500">
                        <div class="form-text">Number of emails to send per batch (1-500)</div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Select Sending Accounts</label>
                        <div class="form-text mb-2">Choose which accounts to use for sending this campaign:</div>
                        <div id="accountSelection" class="border rounded p-3" style="max-height: 200px; overflow-y: auto;">
                            <div class="text-center text-muted">
                                <i class="fas fa-spinner fa-spin me-2"></i>
                                Loading accounts...
                            </div>
                        </div>
                        <div class="form-text mt-2">
                            <button type="button" class="btn btn-sm btn-outline-primary" id="selectAllAccounts">
                                <i class="fas fa-check-square me-1"></i>Select All
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" id="deselectAllAccounts">
                                <i class="fas fa-square me-1"></i>Deselect All
                            </button>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="confirmSendCampaign">
                    <i class="fas fa-play me-2"></i>
                    Start Campaign
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
let currentCampaignId = null;
let availableAccounts = [];

// Wait for DOM to be ready before attaching event listeners
document.addEventListener('DOMContentLoaded', function() {
    // Manual click handler for start campaign buttons
    document.addEventListener('click', function(e) {
        const startBtn = e.target.closest('[data-action="start-campaign"]');
        if (startBtn) {
            e.preventDefault();
            e.stopPropagation();
            
            const campaignId = startBtn.getAttribute('data-id');
            if (campaignId) {
                currentCampaignId = campaignId;
                const modal = new bootstrap.Modal(document.getElementById('sendCampaignModal'));
                modal.show();
            }
        }
    });
    
    // Load accounts when modal is shown
    document.getElementById('sendCampaignModal').addEventListener('show.bs.modal', async function (event) {
        if (!currentCampaignId) {
            console.error('No campaign ID available');
            return;
        }
        
        // Load available accounts
        try {
            const response = await fetch(`/campaigns/${currentCampaignId}/accounts`);
            const data = await response.json();
            
            if (data.success) {
                availableAccounts = data.accounts;
                renderAccountSelection();
            } else {
                document.getElementById('accountSelection').innerHTML = 
                    '<div class="text-center text-danger"><i class="fas fa-exclamation-triangle me-2"></i>Error loading accounts</div>';
            }
        } catch (error) {
            console.error('Error loading accounts:', error);
            document.getElementById('accountSelection').innerHTML = 
                '<div class="text-center text-danger"><i class="fas fa-exclamation-triangle me-2"></i>Error loading accounts</div>';
        }
    });

    // Select all accounts
    document.getElementById('selectAllAccounts').addEventListener('click', function() {
        document.querySelectorAll('#accountSelection input[type="checkbox"]').forEach(checkbox => {
            checkbox.checked = true;
        });
    });

    // Deselect all accounts
    document.getElementById('deselectAllAccounts').addEventListener('click', function() {
        document.querySelectorAll('#accountSelection input[type="checkbox"]').forEach(checkbox => {
            checkbox.checked = false;
        });
    });

    // Confirm send campaign
    document.getElementById('confirmSendCampaign').addEventListener('click', async function() {
        const maxConcurrent = document.getElementById('maxConcurrent').value;
        const proxy = document.getElementById('proxy').value.trim();
        const batchSize = document.getElementById('batchSize').value;
        const emailListFile = document.getElementById('emailListFile').files[0];
        const selectedAccounts = Array.from(document.querySelectorAll('#accountSelection input[type="checkbox"]:checked'))
            .map(checkbox => checkbox.value);
        
        if (selectedAccounts.length === 0) {
            alert('Please select at least one account to send from.');
            return;
        }
        
        // Prepare form data for file upload
        const formData = new FormData();
        formData.append('max_concurrent', parseInt(maxConcurrent));
        formData.append('selected_accounts', JSON.stringify(selectedAccounts));
        formData.append('proxy', proxy || '');
        formData.append('batch_size', parseInt(batchSize));
        
        if (emailListFile) {
            formData.append('email_list_file', emailListFile);
        }
        
        try {
            const response = await fetch(`/campaigns/${currentCampaignId}/send`, {
                method: 'POST',
                body: formData  // Use FormData instead of JSON for file upload
            });
            
            const data = await response.json();
            
            if (data.success) {
                // Close modal and reload page
                bootstrap.Modal.getInstance(document.getElementById('sendCampaignModal')).hide();
                location.reload();
            } else {
                alert('Error starting campaign: ' + data.error);
            }
        } catch (error) {
            console.error('Error starting campaign:', error);
            alert('Error starting campaign. Please try again.');
        }
    });
});

function renderAccountSelection() {
    const container = document.getElementById('accountSelection');
    
    if (availableAccounts.length === 0) {
        container.innerHTML = '<div class="text-center text-muted"><i class="fas fa-info-circle me-2"></i>No accounts available</div>';
        return;
    }
    
    container.innerHTML = availableAccounts.map(account => `
        <div class="form-check mb-2">
            <input class="form-check-input" type="checkbox" value="${account.email}" id="account_${account.email.replace('@', '_at_')}" checked>
            <label class="form-check-label" for="account_${account.email.replace('@', '_at_')}">
                <strong>${account.email}</strong>
                <small class="text-muted ms-2">(${account.type})</small>
            </label>
        </div>
    `).join('');
}

// Auto-refresh dashboard every 30 seconds
setInterval(function() {
    if (document.visibilityState === 'visible') {
        location.reload();
    }
}, 30000);
</script>
{% endblock %}
