{% extends "base.html" %}

{% block title %}Accounts - Email Mass Sender{% endblock %}
{% block page_title %}Email Accounts{% endblock %}

{% block page_actions %}
<div class="btn-toolbar mb-2 mb-md-0">
    <div class="btn-group me-2">
        <a href="{{ url_for('add_account') }}" class="btn btn-primary">
            <i class="fas fa-plus me-2"></i>
            Add Account
        </a>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-users me-2"></i>
                    Email Accounts ({{ accounts|length }})
                </h6>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-primary" onclick="refreshAccounts()">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                    <button class="btn btn-outline-success" onclick="testAllAccounts()">
                        <i class="fas fa-play"></i>
                        Test All
                    </button>
                </div>
            </div>
            <div class="card-body">
                {% if accounts %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Email</th>
                                    <th>Provider</th>
                                    <th>Status</th>
                                    <th>Success Rate</th>
                                    <th>Last Used</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for account in accounts %}
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="me-3">
                                                {% if account.provider == 'office365' %}
                                                    {% if (account.id|string).startswith('cookie_') %}
                                                        <i class="fas fa-cookie-bite text-success" title="Cookie-based"></i>
                                                    {% else %}
                                                        <i class="fas fa-building text-primary"></i>
                                                    {% endif %}
                                                {% elif account.provider == 'gmail' %}
                                                    <i class="fas fa-envelope text-danger"></i>
                                                {% elif account.provider == 'yahoo' %}
                                                    <i class="fas fa-at text-warning"></i>
                                                {% elif account.provider == 'hotmail' %}
                                                    <i class="fas fa-globe text-info"></i>
                                                {% endif %}
                                            </div>
                                            <div>
                                                <strong>{{ account.email }}</strong>
                                                {% if account.is_verified %}
                                                    <i class="fas fa-check-circle text-success ms-1" title="Verified"></i>
                                                {% endif %}
                                                {% if (account.id|string).startswith('cookie_') %}
                                                    <span class="badge bg-success ms-1" title="Cookie Authentication">Cookie</span>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge bg-{{ 'primary' if account.provider == 'office365' else 'danger' if account.provider == 'gmail' else 'warning' if account.provider == 'yahoo' else 'info' }}">
                                            {{ account.provider.upper() }}
                                        </span>
                                    </td>
                                    <td>
                                        {% if account.is_active %}
                                            <span class="badge bg-success">Active</span>
                                        {% else %}
                                            <span class="badge bg-danger">Inactive</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% set total_emails = account.success_count + account.error_count %}
                                        {% if total_emails > 0 %}
                                            {% set success_rate = (account.success_count / total_emails * 100)|round(1) %}
                                            <div class="d-flex align-items-center">
                                                <div class="progress me-2" style="width: 60px; height: 8px;">
                                                    <div class="progress-bar bg-{{ 'success' if success_rate >= 80 else 'warning' if success_rate >= 60 else 'danger' }}" 
                                                         style="width: {{ success_rate }}%"></div>
                                                </div>
                                                <small>{{ success_rate }}%</small>
                                            </div>
                                        {% else %}
                                            <small class="text-muted">No data</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if account.last_used %}
                                            <small>{{ account.last_used.strftime('%Y-%m-%d %H:%M') }}</small>
                                        {% else %}
                                            <small class="text-muted">Never</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <small>{{ account.created_at.strftime('%Y-%m-%d') }}</small>
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            {% if (account.id|string).startswith('cookie_') %}
                                                <!-- Cookie-based account actions -->
                                                <button class="btn btn-outline-primary" 
                                                        onclick="testCookieAccount('{{ account.email }}')"
                                                        title="Test Connection">
                                                    <i class="fas fa-play"></i>
                                                </button>
                                                <button class="btn btn-outline-success"
                                                        onclick="downloadExpandedPeople('{{ account.email }}')"
                                                        title="Download Expanded People Data">
                                                    <i class="fas fa-download"></i>
                                                </button>
                                                <button class="btn btn-outline-primary"
                                                        onclick="downloadProcessedContacts('{{ account.email }}')"
                                                        title="Download Processed Contacts (Office365, GSuite, Others)">
                                                    <i class="fas fa-file-archive"></i>
                                                </button>
                                                <button class="btn btn-outline-info" 
                                                        onclick="viewCookieAccountDetails('{{ account.email }}')"
                                                        title="View Details">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                                <button class="btn btn-outline-warning" 
                                                        onclick="refreshCookieAccount('{{ account.email }}')"
                                                        title="Update Cookies">
                                                    <i class="fas fa-cookie-bite"></i>
                                                </button>
                                                <button class="btn btn-outline-danger" 
                                                        onclick="deleteCookieAccount('{{ account.email }}')"
                                                        title="Delete Account">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            {% else %}
                                                <!-- Regular account actions -->
                                                <button class="btn btn-outline-primary" 
                                                        onclick="testAccount({{ account.id }})"
                                                        title="Test Connection">
                                                    <i class="fas fa-play"></i>
                                                </button>
                                                <button class="btn btn-outline-success"
                                                        onclick="downloadExpandedPeople('{{ account.email }}')"
                                                        title="Download Expanded People Data">
                                                    <i class="fas fa-download"></i>
                                                </button>
                                                <button class="btn btn-outline-primary"
                                                        onclick="downloadProcessedContacts('{{ account.email }}')"
                                                        title="Download Processed Contacts (Office365, GSuite, Others)">
                                                    <i class="fas fa-file-archive"></i>
                                                </button>
                                                <button class="btn btn-outline-info" 
                                                        onclick="viewAccountDetails({{ account.id }})"
                                                        title="View Details">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                                <button class="btn btn-outline-warning" 
                                                        onclick="refreshAccount({{ account.id }})"
                                                        title="Refresh Token">
                                                    <i class="fas fa-sync-alt"></i>
                                                </button>
                                                <button class="btn btn-outline-danger" 
                                                        onclick="deleteAccount({{ account.id }})"
                                                        title="Delete Account">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-users fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No accounts found</h5>
                        <p class="text-muted">Add your first email account to get started</p>
                        <a href="{{ url_for('add_account') }}" class="btn btn-primary">
                            <i class="fas fa-plus me-2"></i>
                            Add Account
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Account Details Modal -->
<div class="modal fade" id="accountDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-user me-2"></i>
                    Account Details
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="accountDetailsContent">
                    <!-- Content will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function testAccount(accountId) {
    showLoading($('body'));
    
    $.ajax({
        url: `/accounts/${accountId}/test`,
        method: 'POST',
        success: function(response) {
            hideLoading($('body'));
            if (response.success) {
                showAlert('success', 'Account test successful!');
            } else {
                showAlert('error', response.error || 'Account test failed');
            }
        },
        error: function(xhr, status, error) {
            hideLoading($('body'));
            handleAjaxError(xhr, status, error);
        }
    });
}

function testAllAccounts() {
    if (confirm('Test all accounts? This may take a few minutes.')) {
        showLoading($('body'));
        
        $.ajax({
            url: '/accounts/test-all',
            method: 'POST',
            success: function(response) {
                hideLoading($('body'));
                if (response.success) {
                    showAlert('success', `Tested ${response.tested} accounts. ${response.successful} successful, ${response.failed} failed.`);
                } else {
                    showAlert('error', response.error || 'Failed to test accounts');
                }
            },
            error: function(xhr, status, error) {
                hideLoading($('body'));
                handleAjaxError(xhr, status, error);
            }
        });
    }
}

function viewAccountDetails(accountId) {
    $.ajax({
        url: `/accounts/${accountId}/details`,
        method: 'GET',
        success: function(response) {
            if (response.success) {
                $('#accountDetailsContent').html(response.html);
                $('#accountDetailsModal').modal('show');
            } else {
                showAlert('error', response.error || 'Failed to load account details');
            }
        },
        error: handleAjaxError
    });
}

function refreshAccount(accountId) {
    if (confirm('Refresh account token? This will re-authenticate the account.')) {
        showLoading($('body'));
        
        $.ajax({
            url: `/accounts/${accountId}/refresh`,
            method: 'POST',
            success: function(response) {
                hideLoading($('body'));
                if (response.success) {
                    showAlert('success', 'Account token refreshed successfully!');
                    setTimeout(() => location.reload(), 2000);
                } else {
                    showAlert('error', response.error || 'Failed to refresh account token');
                }
            },
            error: function(xhr, status, error) {
                hideLoading($('body'));
                handleAjaxError(xhr, status, error);
            }
        });
    }
}

function deleteAccount(accountId) {
    if (confirm('Are you sure you want to delete this account? This action cannot be undone.')) {
        showLoading($('body'));
        
        $.ajax({
            url: `/accounts/${accountId}/delete`,
            method: 'DELETE',
            success: function(response) {
                hideLoading($('body'));
                if (response.success) {
                    showAlert('success', 'Account deleted successfully!');
                    setTimeout(() => location.reload(), 2000);
                } else {
                    showAlert('error', response.error || 'Failed to delete account');
                }
            },
            error: function(xhr, status, error) {
                hideLoading($('body'));
                handleAjaxError(xhr, status, error);
            }
        });
    }
}

function refreshAccounts() {
    location.reload();
}

function downloadExpandedPeople(email) {
    const overlay = document.getElementById('exportLoading');
    if (overlay) overlay.classList.remove('d-none');
    const url = `/office365/accounts/${encodeURIComponent(email)}/export-expanded-people`;
    const filename = `export_from_${email}.txt`;

    fetch(url)
        .then(async res => {
            if (!res.ok) {
                const data = await res.json().catch(() => ({}));
                throw new Error(data.error || `Export failed with status ${res.status}`);
            }
            return res.blob();
        })
        .then(blob => {
            const link = document.createElement('a');
            const objectUrl = window.URL.createObjectURL(blob);
            link.href = objectUrl;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            link.remove();
            window.URL.revokeObjectURL(objectUrl);
            showAlert('success', `Downloading ${filename}`);
        })
        .catch(err => {
            console.error('Export error:', err);
            showAlert('error', err.message || 'Failed to download expanded people data');
        })
        .finally(() => {
            if (overlay) overlay.classList.add('d-none');
        });
}

function downloadProcessedContacts(email) {
    const overlay = document.getElementById('exportLoading');
    if (overlay) overlay.classList.remove('d-none');
    const url = `/office365/accounts/${encodeURIComponent(email)}/export-processed-contacts`;
    const filename = `${email.replace('@', '_at_').replace('.', '_')}-processed-contacts.zip`;

    fetch(url)
        .then(async res => {
            if (!res.ok) {
                const data = await res.json().catch(() => ({}));
                throw new Error(data.error || `Processed export failed with status ${res.status}`);
            }
            return res.blob();
        })
        .then(blob => {
            const link = document.createElement('a');
            const objectUrl = window.URL.createObjectURL(blob);
            link.href = objectUrl;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            link.remove();
            window.URL.revokeObjectURL(objectUrl);
            showAlert('success', `Downloading processed contacts: ${filename}`);
        })
        .catch(err => {
            console.error('Processed export error:', err);
            showAlert('error', err.message || 'Failed to download processed contacts');
        })
        .finally(() => {
            if (overlay) overlay.classList.add('d-none');
        });
}

// Cookie-based account functions
function testCookieAccount(email) {
    showAlert('info', 'Testing cookie account...');
    
    fetch(`/office365/accounts/${encodeURIComponent(email)}/test`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', 'Cookie account test successful!');
        } else {
            showAlert('danger', data.message || 'Cookie account test failed');
        }
    })
    .catch(error => {
        showAlert('danger', 'Error testing cookie account: ' + error.message);
    });
}

function viewCookieAccountDetails(email) {
    fetch(`/office365/accounts/${encodeURIComponent(email)}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const account = data.account;
                const details = `
                    <strong>Email:</strong> ${account.email}<br>
                    <strong>Account Type:</strong> ${account.account_type}<br>
                    <strong>Status:</strong> ${account.status}<br>
                    <strong>Added:</strong> ${account.added_at ? new Date(account.added_at).toLocaleString() : 'N/A'}<br>
                    <strong>Last Used:</strong> ${account.last_used ? new Date(account.last_used).toLocaleString() : 'Never'}<br>
                    <strong>Cookies:</strong> ${account.cookies ? account.cookies.length : 0} cookies stored
                `;
                showAlert('info', details);
            } else {
                showAlert('danger', 'Failed to load account details');
            }
        })
        .catch(error => {
            showAlert('danger', 'Error loading account details: ' + error.message);
        });
}

function refreshCookieAccount(email) {
    if (confirm(`Update cookies for ${email}?`)) {
        // For now, just show instructions
        showAlert('info', 'To update cookies: 1) Delete this account, 2) Add a new account with fresh cookies');
    }
}

function deleteCookieAccount(email) {
    if (confirm(`Are you sure you want to delete the cookie account ${email}?`)) {
        fetch(`/office365/accounts/${encodeURIComponent(email)}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('success', 'Cookie account deleted successfully!');
                location.reload();
            } else {
                showAlert('danger', data.message || 'Failed to delete cookie account');
            }
        })
        .catch(error => {
            showAlert('danger', 'Error deleting cookie account: ' + error.message);
        });
    }
}

// Auto-refresh every 60 seconds
setInterval(function() {
    if (document.visibilityState === 'visible') {
        location.reload();
    }
}, 60000);
</script>

<!-- Export Loading Overlay -->
<div id="exportLoading" class="position-fixed top-0 start-0 w-100 h-100 d-none" style="background: rgba(0,0,0,0.35); z-index: 2000;">
    <div class="d-flex align-items-center justify-content-center w-100 h-100">
        <div class="bg-white p-3 rounded shadow-sm d-flex align-items-center gap-2">
            <i class="fas fa-spinner fa-spin"></i>
            <span>Preparing download...</span>
        </div>
    </div>
</div>

{% endblock %}
